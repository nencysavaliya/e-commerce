{% extends 'base.html' %}

{% block title %}Checkout - IndiVibe{% endblock %}

{% block content %}
<div class="container">
    <h2><i class="fas fa-credit-card"></i> Checkout</h2>

    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; margin-top: 2rem;">
        <!-- Shipping Address -->
        <div>
            <div class="card" style="padding: 1.5rem; margin-bottom: 2rem;">
                <h3><i class="fas fa-map-marker-alt"></i> Shipping Address</h3>

                {% if addresses %}
                <form method="post">
                    {% csrf_token %}
                    <div class="grid grid-2 mt-3">
                        {% for addr in addresses %}
                        <label class="card"
                            style="padding: 1rem; cursor: pointer; {% if addr.is_default %}border-color: var(--primary);{% endif %}">
                            <input type="radio" name="address_id" value="{{ addr.id }}" {% if addr.is_default %}checked{% endif %} required style="margin-right: 0.5rem;">
                            <strong>{{ addr.name }}</strong>
                            <p class="text-muted" style="font-size: 0.9rem;">{{ addr.phone }}</p>
                            <p class="text-secondary" style="font-size: 0.85rem;">{{ addr.full_address }}</p>
                        </label>
                        {% endfor %}
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg mt-4">
                        <i class="fas fa-lock"></i> Proceed to Payment
                    </button>
                </form>
                {% else %}
                <p class="text-muted mt-2">No saved addresses. Please add one.</p>
                {% endif %}

                <hr style="border-color: rgba(255,255,255,0.1); margin: 2rem 0;">

                <h4><i class="fas fa-plus"></i> Add New Address</h4>
                <form method="post" action="{% url 'orders:add_address' %}" class="mt-3">
                    {% csrf_token %}
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input type="text" name="name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="text" name="phone" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <textarea name="address" class="form-control" rows="2" required></textarea>
                    </div>
                    <div class="grid grid-3">
                        <div class="form-group">
                            <label class="form-label">City</label>
                            <input type="text" name="city" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">State</label>
                            <input type="text" name="state" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">PIN Code</label>
                            <input type="text" name="pincode" class="form-control" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-secondary">
                        <i class="fas fa-plus"></i> Save Address
                    </button>
                </form>
            </div>
        </div>

        <!-- Order Summary -->
        <div class="cart-summary">
            <h3>Order Summary</h3>
            <hr style="border-color: rgba(255,255,255,0.1); margin: 1rem 0;">

            {% for item in cart_items %}
            <div class="d-flex justify-between mb-2">
                <span>{{ item.product.name|truncatechars:20 }} x {{ item.quantity }}</span>
                <span>₹{{ item.total_price }}</span>
            </div>
            {% endfor %}

            <hr style="border-color: rgba(255,255,255,0.1); margin: 1rem 0;">

            <!-- Coupon Section -->
            <div style="margin-bottom: 1.5rem;">
                <h4 style="font-size: 0.95rem; margin-bottom: 0.8rem;">
                    <i class="fas fa-tags"></i> Have a Coupon Code?
                </h4>

                {% if applied_coupon %}
                <!-- Applied Coupon Display -->
                <div class="card"
                    style="padding: 1rem; background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(76, 175, 80, 0.05)); border-color: #4CAF50;">
                    <div class="d-flex justify-between align-center">
                        <div>
                            <div style="font-weight: bold; color: #4CAF50;">
                                <i class="fas fa-check-circle"></i> {{ applied_coupon.code }}
                            </div>
                            <div style="font-size: 0.85rem; color: #4CAF50;">
                                You save ₹{{ applied_coupon.discount }}
                            </div>
                        </div>
                        <button type="button" onclick="removeCoupon()" class="btn btn-sm"
                            style="background: rgba(244, 67, 54, 0.1); color: #f44336; padding: 0.4rem 0.8rem;">
                            <i class="fas fa-times"></i> Remove
                        </button>
                    </div>
                </div>
                {% else %}
                <!-- Coupon Input Form -->
                <form id="couponForm" onsubmit="applyCoupon(event)" style="display: flex; gap: 0.5rem;">
                    <input type="text" id="couponCode" name="code" placeholder="Enter coupon code" class="form-control"
                        style="flex: 1; text-transform: uppercase;" required>
                    <button type="submit" class="btn btn-secondary" style="white-space: nowrap;">
                        <i class="fas fa-tag"></i> Apply
                    </button>
                </form>
                <div id="couponMessage" style="margin-top: 0.5rem; font-size: 0.85rem;"></div>
                {% endif %}
            </div>

            <hr style="border-color: rgba(255,255,255,0.1); margin: 1rem 0;">

            <div class="d-flex justify-between mb-2">
                <span class="text-muted">Subtotal</span>
                <span id="subtotalAmount">₹{{ cart.subtotal }}</span>
            </div>
            <div class="d-flex justify-between mb-2">
                <span class="text-muted">Shipping</span>
                <span class="text-success">Free</span>
            </div>
            {% if applied_coupon %}
            <div class="d-flex justify-between mb-2" style="color: #4CAF50;">
                <span><i class="fas fa-tag"></i> Discount</span>
                <span id="discountAmount">₹{{ applied_coupon.discount }}</span>
            </div>
            {% endif %}

            <hr style="border-color: rgba(255,255,255,0.1); margin: 1rem 0;">

            <div class="d-flex justify-between">
                <strong>Total</strong>
                <strong id="finalTotal" style="font-size: 1.5rem; color: var(--secondary);">₹{{ final_amount|default:cart.subtotal }}</strong>
                    

            </div>
        </div>
    </div>
</div>

<script>
    function applyCoupon(event) {
        event.preventDefault();

        const code = document.getElementById('couponCode').value.trim().toUpperCase();
        const messageDiv = document.getElementById('couponMessage');
        const subtotal = {{ cart.subtotal }};
  

    if (!code) {
        messageDiv.innerHTML = '<span style="color: #f44336;"><i class="fas fa-exclamation-circle"></i> Please enter a coupon code</span>';
        return;
    }

    // Show loading state
    messageDiv.innerHTML = '<span style="color: #2196F3;"><i class="fas fa-spinner fa-spin"></i> Validating coupon...</span>';

    // Prepare form data
    const formData = new FormData();
    formData.append('code', code);
    formData.append('order_amount', subtotal);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    fetch('{% url "coupons:apply" %}', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                messageDiv.innerHTML = '<span style="color: #4CAF50;"><i class="fas fa-check-circle"></i> ' + data.message + '</span>';
                // Reload page to show applied coupon
                setTimeout(() => window.location.reload(), 1000);
            } else {
                messageDiv.innerHTML = '<span style="color: #f44336;"><i class="fas fa-exclamation-circle"></i> ' + data.message + '</span>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            messageDiv.innerHTML = '<span style="color: #f44336;"><i class="fas fa-exclamation-circle"></i> Failed to apply coupon. Please try again.</span>';
        });
}

    function removeCoupon() {
        if (!confirm('Are you sure you want to remove this coupon?')) {
            return;
        }

        fetch('{% url "coupons:remove" %}', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reload page to update UI
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to remove coupon. Please try again.');
            });
    }
</script>
{% endblock %}
